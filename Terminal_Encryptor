#!/usr/bin/bash

# Terminal Encryptor V1.1.2 - Secure Edition with Support System
# Полностью зашифрованная система с онлайн-режимом и поддержкой

# ============================================
# КОНФИГУРАЦИЯ БЕЗОПАСНОСТИ И ПОДДЕРЖКИ
# ============================================

# Контакты поддержки
DEVELOPER_TG="@bred37"
NEWS_CHANNEL="t.me/TerminalEncryptor"
GITHUB_REPO="TerminalEncryptor"

# Шифрование AES-256-GCM
ENCRYPTION_KEY="$(openssl rand -hex 32)"
IV_LENGTH=12
TAG_LENGTH=16

# Каталоги безопасности
SECURE_DIR="$HOME/.terminal_encryptor_secure"
KEYS_DIR="$SECURE_DIR/keys"
DATA_DIR="$SECURE_DIR/encrypted_data"
LOGS_DIR="$SECURE_DIR/logs"
SOCKET_DIR="$SECURE_DIR/sockets"
SUPPORT_DIR="$SECURE_DIR/support"
CONFIG_DIR="$SECURE_DIR/config"

# Сервер онлайн-режима
ONLINE_SERVER="encryptor-server.example.com"
ONLINE_PORT="443"
USE_TLS=true

# ============================================
# СИСТЕМА ЦВЕТОВЫХ ТЕМ
# ============================================

# Тема по умолчанию (Dark)
COLOR_THEME="dark"

# Доступные темы
declare -A THEMES=(
    ["dark"]="RED='\033[0;31m' GREEN='\033[0;32m' YELLOW='\033[1;33m' BLUE='\033[0;34m' PURPLE='\033[0;35m' CYAN='\033[0;36m' WHITE='\033[1;37m'"
    ["light"]="RED='\033[0;91m' GREEN='\033[0;92m' YELLOW='\033[0;93m' BLUE='\033[0;94m' PURPLE='\033[0;95m' CYAN='\033[0;96m' WHITE='\033[0;97m'"
    ["neon"]="RED='\033[1;31m' GREEN='\033[1;32m' YELLOW='\033[1;33m' BLUE='\033[1;34m' PURPLE='\033[1;35m' CYAN='\033[1;36m' WHITE='\033[1;37m'"
    ["matrix"]="RED='\033[0;32m' GREEN='\033[1;32m' YELLOW='\033[0;32m' BLUE='\033[0;32m' PURPLE='\033[1;32m' CYAN='\033[0;32m' WHITE='\033[1;32m'"
    ["ocean"]="RED='\033[0;36m' GREEN='\033[0;34m' YELLOW='\033[0;94m' BLUE='\033[1;34m' PURPLE='\033[0;35m' CYAN='\033[1;36m' WHITE='\033[1;97m'"
    ["fire"]="RED='\033[1;31m' GREEN='\033[0;91m' YELLOW='\033[1;33m' BLUE='\033[0;31m' PURPLE='\033[0;35m' CYAN='\033[1;33m' WHITE='\033[1;37m'"
)

# Цвета по умолчанию (будут перезаписаны при загрузке темы)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# ============================================
# ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ
# ============================================

current_user=""
current_user_id=""
current_language="ru"
online_mode=false
session_token=""
SESSION_ID=""

# ============================================
# ФУНКЦИИ УПРАВЛЕНИЯ ЦВЕТОВЫМИ ТЕМАМИ
# ============================================

load_color_theme() {
    local theme="$1"
    
    if [ -z "${THEMES[$theme]}" ]; then
        theme="dark" # Fallback к dark теме
    fi
    
    # Загружаем цвета выбранной темы
    eval "${THEMES[$theme]}"
    COLOR_THEME="$theme"
    
    # Сохраняем выбор в конфиг
    save_config "color_theme" "$theme"
    
    echo -e "${GREEN}Тема '$theme' загружена!${NC}"
}

show_theme_preview() {
    local theme="$1"
    local current_colors="${THEMES[$theme]}"
    
    # Временная загрузка темы для предпросмотра
    eval "$current_colors"
    
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    echo -e "${RED}Красный текст${NC} - ${GREEN}Зеленый текст${NC}"
    echo -e "${YELLOW}Желтый текст${NC} - ${BLUE}Синий текст${NC}"
    echo -e "${PURPLE}Фиолетовый текст${NC} - ${CYAN}Голубой текст${NC}"
    echo -e "${WHITE}Белый текст${NC}"
    echo -e "${GREEN}════════════════════════════════════════${NC}"
    
    # Возвращаем оригинальные цвета
    load_color_theme "$COLOR_THEME"
}

change_color_theme_menu() {
    while true; do
        clear
        echo -e "${PURPLE}╔════════════════════════════════════════╗${NC}"
        echo -e "${PURPLE}║     СМЕНА ЦВЕТОВОЙ ТЕМЫ               ║${NC}"
        echo -e "${PURPLE}╚════════════════════════════════════════╝${NC}\n"
        
        echo -e "${CYAN}Текущая тема: ${WHITE}$COLOR_THEME${NC}\n"
        echo -e "${YELLOW}Доступные темы:${NC}"
        echo -e "1. ${RED}●${NC} Темная (стандартная)"
        echo -e "2. ${WHITE}●${NC} Светлая"
        echo -e "3. ${CYAN}●${NC} Неоновая"
        echo -e "4. ${GREEN}●${NC} Матрица"
        echo -e "5. ${BLUE}●${NC} Океан"
        echo -e "6. ${RED}●${NC} Огненная"
        echo -e "7. ${YELLOW}●${NC} Просмотр темы"
        echo -e "8. ${WHITE}●${NC} Назад в меню\n"
        
        read -p "Выберите тему (1-8): " theme_choice
        
        case $theme_choice in
            1) load_color_theme "dark" ;;
            2) load_color_theme "light" ;;
            3) load_color_theme "neon" ;;
            4) load_color_theme "matrix" ;;
            5) load_color_theme "ocean" ;;
            6) load_color_theme "fire" ;;
            7) 
                echo -e "\n${CYAN}Выберите тему для предпросмотра:${NC}"
                select theme_name in "${!THEMES[@]}" "Назад"; do
                    if [ "$theme_name" = "Назад" ]; then
                        break
                    elif [ -n "$theme_name" ]; then
                        show_theme_preview "$theme_name"
                        read -p "Нажмите Enter чтобы продолжить..."
                    fi
                    break
                done
                ;;
            8) return ;;
            *) echo -e "${RED}Неверный выбор!${NC}"; sleep 1 ;;
        esac
        
        if [ "$theme_choice" -lt 7 ]; then
            echo -e "${GREEN}Тема успешно изменена!${NC}"
            sleep 1
        fi
    done
}

save_config() {
    local key="$1"
    local value="$2"
    
    mkdir -p "$CONFIG_DIR"
    echo "$value" > "$CONFIG_DIR/$key.cfg"
    chmod 600 "$CONFIG_DIR/$key.cfg"
}

load_config() {
    local key="$1"
    local default="$2"
    
    if [ -f "$CONFIG_DIR/$key.cfg" ]; then
        cat "$CONFIG_DIR/$key.cfg"
    else
        echo "$default"
    fi
}

# ============================================
# ОСНОВНЫЕ ФУНКЦИИ БЕЗОПАСНОСТИ
# ============================================

init_secure_environment() {
    echo -e "${YELLOW}Инициализация защищенной среды...${NC}"
    
    # Создание защищенных каталогов
    mkdir -p "$SECURE_DIR" "$KEYS_DIR" "$DATA_DIR" "$LOGS_DIR" "$SOCKET_DIR" \
             "$SUPPORT_DIR" "$CONFIG_DIR" 2>/dev/null
    
    # Установка правильных разрешений
    chmod 700 "$SECURE_DIR"
    find "$SECURE_DIR" -type d -exec chmod 700 {} \;
    
    # Загрузка сохраненной темы
    local saved_theme=$(load_config "color_theme" "dark")
    load_color_theme "$saved_theme"
    
    # Создание мастер-ключа при первом запуске
    if [ ! -f "$KEYS_DIR/master.key" ]; then
        openssl rand -base64 32 > "$KEYS_DIR/master.key"
        chmod 400 "$KEYS_DIR/master.key"
        echo -e "${GREEN}Сгенерирован новый мастер-ключ${NC}"
    fi
    
    # Загрузка мастер-ключа
    if [ -f "$KEYS_DIR/master.key" ]; then
        MASTER_KEY="$(cat "$KEYS_DIR/master.key")"
    else
        echo -e "${RED}Ошибка: Не найден мастер-ключ!${NC}"
        exit 1
    fi
    
    # Генерация ID сессии
    SESSION_ID="$(date +%s%N | sha256sum | head -c 16)"
    
    echo -e "${GREEN}Защищенная среда инициализирована${NC}"
    echo -e "${BLUE}Сессия: ${WHITE}$SESSION_ID${NC}"
    log_audit "SYSTEM_INIT" "Secure environment initialized with theme: $COLOR_THEME"
}

# ============================================
# ФУНКЦИИ ШИФРОВАНИЯ (сохраненные из предыдущих версий)
# ============================================

encrypt_data() {
    local plaintext="$1"
    local context="$2"

    local iv=$(openssl rand -hex $IV_LENGTH)
    local encrypted=$(echo -n "$plaintext" | openssl enc -aes-256-gcm \
        -K "$(echo -n "$MASTER_KEY" | sha256sum | cut -d' ' -f1)" \
        -iv "$iv" \
        -a -A 2>/dev/null)

    if [ $? -eq 0 ]; then
        echo "${iv}:${encrypted}:${context}"
        log_audit "ENCRYPT_SUCCESS" "Data encrypted for context: $context"
    else
        log_audit "ENCRYPT_FAIL" "Encryption failed for context: $context"
        echo ""
    fi
}

decrypt_data() {
    local encrypted_data="$1"

    local iv=$(echo "$encrypted_data" | cut -d':' -f1)
    local data=$(echo "$encrypted_data" | cut -d':' -f2)
    local context=$(echo "$encrypted_data" | cut -d':' -f3)

    local decrypted=$(echo -n "$data" | openssl enc -d -aes-256-gcm \
        -K "$(echo -n "$MASTER_KEY" | sha256sum | cut -d' ' -f1)" \
        -iv "$iv" \
        -a -A 2>/dev/null)

    if [ $? -eq 0 ]; then
        log_audit "DECRYPT_SUCCESS" "Data decrypted for context: $context"
        echo "$decrypted"
    else
        log_audit "DECRYPT_FAIL" "Decryption failed"
        echo ""
    fi
}

log_audit() {
    local event_type="$1"
    local message="$2"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    local user="${current_user:-"SYSTEM"}"
    local session_id="${SESSION_ID:-"NO_SESSION"}"

    local log_entry="$timestamp | $event_type | $user | $session_id | $message | THEME:$COLOR_THEME"

    echo "$log_entry" >> "$LOGS_DIR/audit_$SESSION_ID.log"
    echo "[AUDIT] $log_entry" >> "$LOGS_DIR/system.log"
}

# ============================================
# ГЛАВНОЕ МЕНЮ С ПОДДЕРЖКОЙ
# ============================================

show_welcome_menu() {
    clear
    echo -e "${PURPLE}╔══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${PURPLE}║             TERMINAL ENCRYPTOR V1.1.2                   ║${NC}"
    echo -e "${PURPLE}║         Защищенная система шифрования и сетей          ║${NC}"
    echo -e "${PURPLE}╚══════════════════════════════════════════════════════════╝${NC}\n"

    echo -e "${CYAN}╔══════════════════════════════════════════════════════════╗${NC}"
    echo -e "${CYAN}║                      ПОДДЕРЖКА                           ║${NC}"
    echo -e "${CYAN}║                                                          ║${NC}"
    echo -e "${CYAN}║  ${WHITE}Связаться с разработчиком: ${YELLOW}$DEVELOPER_TG${NC}                ${CYAN}║${NC}"
    echo -e "${CYAN}║  ${WHITE}Следить за новостями: ${YELLOW}$NEWS_CHANNEL${NC}                     ${CYAN}║${NC}"
    echo -e "${CYAN}║  ${WHITE}GitHub репозиторий: ${YELLOW}$GITHUB_REPO${NC}                        ${CYAN}║${NC}"
    echo -e "${CYAN}║  ${WHITE}Текущая цветовая тема: ${YELLOW}$COLOR_THEME${NC}                     ${CYAN}║${NC}"
    echo -e "${CYAN}╚══════════════════════════════════════════════════════════╝${NC}\n"

    echo -e "${GREEN}Добро пожаловать в систему Terminal Encryptor!${NC}\n"

    if [ -z "$current_user" ]; then
        echo -e "${YELLOW}1. Вход в систему${NC}"
        echo -e "${YELLOW}2. Регистрация${NC}"
        echo -e "${YELLOW}3. Смена цветовой темы${NC}"
        echo -e "${YELLOW}4. Выход${NC}"
    else
        echo -e "${GREEN}Вы вошли как: ${WHITE}$current_user${NC}"
        echo -e "${CYAN}ID сессии: ${WHITE}$SESSION_ID${NC}"
        echo -e "${BLUE}Тема интерфейса: ${WHITE}$COLOR_THEME${NC}\n"

        echo -e "${YELLOW}1. Шифрование${NC}"
        echo -e "${YELLOW}2. Управление каналами${NC}"
        echo -e "${YELLOW}3. Управление сетями${NC}"
        echo -e "${YELLOW}4. Настройки${NC}"
        echo -e "${YELLOW}5. Настройки аккаунта${NC}"
        echo -e "${YELLOW}6. Добавить друга${NC}"
        echo -e "${YELLOW}7. Смена цветовой темы${NC}"
        echo -e "${YELLOW}8. Выход из аккаунта${NC}"
    fi

    echo -e "\n${WHITE}══════════════════════════════════════════════════════════${NC}"
}

# ============================================
# ФУНКЦИИ РЕГИСТРАЦИИ И АВТОРИЗАЦИИ
# ============================================

register_user() {
    clear
    echo -e "${PURPLE}╔════════════════════════════════════════╗${NC}"
    echo -e "${PURPLE}║           РЕГИСТРАЦИЯ                 ║${NC}"
    echo -e "${PURPLE}╚════════════════════════════════════════╝${NC}\n"

    read -p "Введите имя пользователя: " username
    read -sp "Введите пароль: " password
    echo
    read -sp "Повторите пароль: " password2
    echo

    if [ "$password" != "$password2" ]; then
        echo -e "${RED}Пароли не совпадают!${NC}"
        sleep 2
        return 1
    fi

    if [ ${#password} -lt 6 ]; then
        echo -e "${RED}Пароль должен содержать минимум 6 символов!${NC}"
        sleep 2
        return 1
    fi

    echo -e "${CYAN}Выберите язык:${NC}"
    echo -e "1. Русский"
    echo -e "2. Английский"
    read -p "Ваш выбор (1-2): " lang_choice

    case $lang_choice in
        1) language="ru" ;;
        2) language="en" ;;
        *) language="ru" ;;
    esac

    # Создаём каталоги если их нет
    mkdir -p "$DATA_DIR"
    touch "$DATA_DIR/users.db.enc"
    chmod 600 "$DATA_DIR/users.db.enc" 2>/dev/null || true

    # Проверка на дубликат имени пользователя
    if [ -f "$DATA_DIR/users.db.enc" ]; then
        while IFS= read -r line; do
            # line формат: user_id:encrypted_blob
            existing_enc="${line#*:}"
            if [ -n "$existing_enc" ]; then
                existing_data="$(decrypt_data "$existing_enc")"
                if [ -n "$existing_data" ]; then
                    existing_name=$(echo "$existing_data" | grep -o 'USERNAME=[^|]*' | cut -d'=' -f2)
                    if [ "$existing_name" = "$username" ]; then
                        echo -e "${RED}Пользователь с таким именем уже существует!${NC}"
                        log_audit "REGISTER_FAIL" "Attempt to register duplicate username: $username"
                        sleep 2
                        return 1
                    fi
                fi
            fi
        done < "$DATA_DIR/users.db.enc"
    fi

    # Генерация ID пользователя
    user_id="USR_$(date +%s%N | sha256sum | head -c 8)"

    # Хэширование пароля
    password_hash=$(echo -n "$password" | sha256sum | cut -d' ' -f1)

    # Шифрование данных пользователя
    user_data="USERNAME=$username|PASSWORD_HASH=$password_hash|LANGUAGE=$language|REG_DATE=$(date +%Y-%m-%d)"
    encrypted_user=$(encrypt_data "$user_data" "USER_$user_id")

    # Сохранение пользователя
    echo "$user_id:$encrypted_user" >> "$DATA_DIR/users.db.enc"
    chmod 600 "$DATA_DIR/users.db.enc" 2>/dev/null || true

    echo -e "\n${GREEN}Регистрация успешна!${NC}"
    echo -e "${BLUE}Ваш ID: ${WHITE}$user_id${NC}"
    echo -e "${YELLOW}Запомните ваш ID для входа!${NC}"

    log_audit "USER_REGISTER" "New user registered: $username ($user_id)"
    sleep 3
    return 0
}

login_user() {
    clear
    echo -e "${PURPLE}╔════════════════════════════════════════╗${NC}"
    echo -e "${PURPLE}║               ВХОД                    ║${NC}"
    echo -e "${PURPLE}╚════════════════════════════════════════╝${NC}\n"

    read -p "Введите ваш ID пользователя: " user_id
    read -sp "Введите пароль: " password
    echo

    if [ ! -f "$DATA_DIR/users.db.enc" ]; then
        echo -e "${RED}База данных пользователей не найдена!${NC}"
        sleep 2
        return 1
    fi

    while IFS= read -r line; do
        local stored_id="${line%%:*}"

        if [ "$stored_id" = "$user_id" ]; then
            local encrypted="${line#*:}"
            local user_data="$(decrypt_data "$encrypted")"

            if [ -z "$user_data" ]; then
                echo -e "${RED}Ошибка чтения данных пользователя!${NC}"
                sleep 2
                return 1
            fi

            local username=$(echo "$user_data" | grep -o 'USERNAME=[^|]*' | cut -d'=' -f2)
            local stored_hash=$(echo "$user_data" | grep -o 'PASSWORD_HASH=[^|]*' | cut -d'=' -f2)
            local lang=$(echo "$user_data" | grep -o 'LANGUAGE=[^|]*' | cut -d'=' -f2)

            local input_hash=$(echo -n "$password" | sha256sum | cut -d' ' -f1)

            if [ "$input_hash" = "$stored_hash" ]; then
                # УСТАНАВЛИВАЕМ ПЕРЕМЕННЫЕ
                current_user="$username"
                current_user_id="$user_id"
                current_language="$lang"

                # Генерация токена
                session_token="SESS_$(date +%s%N | sha256sum | head -c 16)"

                echo -e "\n${GREEN}Вход выполнен успешно!${NC}"
                echo -e "${BLUE}Добро пожаловать, ${WHITE}$current_user${NC}!"
                log_audit "USER_LOGIN" "Login: $current_user ($current_user_id)"

                sleep 2
                return 0
            else
                echo -e "${RED}Неверный пароль!${NC}"
                log_audit "LOGIN_FAIL" "Wrong password for $user_id"
                sleep 2
                return 1
            fi
        fi
    done < "$DATA_DIR/users.db.enc"

    echo -e "${RED}Пользователь с таким ID не найден!${NC}"
    sleep 2
    return 1
}

# ============================================
# ОСНОВНЫЕ МЕНЮ (УПРОЩЕННЫЕ ВЕРСИИ)
# ============================================

encryption_menu() {
    while true; do
        clear
        echo -e "${PURPLE}╔════════════════════════════════════════╗${NC}"
        echo -e "${PURPLE}║           МЕНЮ ШИФРОВАНИЯ             ║${NC}"
        echo -e "${PURPLE}╚════════════════════════════════════════╝${NC}\n"

        echo -e "${CYAN}Текущий пользователь: ${WHITE}$current_user${NC}"
        echo -e "${YELLOW}ID сессии: ${WHITE}$SESSION_ID${NC}\n"

        echo -e "${GREEN}1. Зашифровать текст${NC}"
        echo -e "${GREEN}2. Расшифровать текст${NC}"
        echo -e "${GREEN}3. Зашифровать символы/цифры${NC}"
        echo -e "${GREEN}4. Расшифровать символы/цифры${NC}"
        echo -e "${GREEN}5. Зашифровать IP${NC}"
        echo -e "${GREEN}6. Расшифровать IP${NC}"
        echo -e "${GREEN}7. Выйти в главное меню${NC}"

        echo -e "\n${WHITE}════════════════════════════════════════${NC}"
        read -p "Выберите действие (1-7): " choice

        case $choice in
            1)
                echo -e "\n${CYAN}Введите текст для шифрования:${NC}"
                read text
                encrypted=$(encrypt_data "$text" "TEXT_ENCRYPTION")
                echo -e "${GREEN}Зашифрованный текст:${NC}"
                echo -e "${WHITE}$encrypted${NC}"
                ;;
            2)
                echo -e "\n${CYAN}Введите зашифрованный текст:${NC}"
                read encrypted_text
                decrypted=$(decrypt_data "$encrypted_text")
                echo -e "${GREEN}Расшифрованный текст:${NC}"
                echo -e "${WHITE}$decrypted${NC}"
                ;;
            3)
                echo -e "\n${CYAN}Введите символы/цифры для шифрования:${NC}"
                read chars
                # Простой шифр замены
                encrypted_chars=$(echo "$chars" | tr '0-9A-Za-z' '9-0Z-Az-a')
                echo -e "${GREEN}Зашифровано:${NC} ${WHITE}$encrypted_chars${NC}"
                ;;
            4)
                echo -e "\n${CYAN}Введите зашифрованные символы:${NC}"
                read encrypted_chars
                decrypted_chars=$(echo "$encrypted_chars" | tr '9-0Z-Az-a' '0-9A-Za-z')
                echo -e "${GREEN}Расшифровано:${NC} ${WHITE}$decrypted_chars${NC}"
                ;;
            5)
                echo -e "\n${CYAN}Введите IP-адрес:${NC}"
                read ip
                encrypted_ip=$(echo "$ip" | tr '0123456789.' '9876543210@')
                echo -e "${GREEN}Зашифрованный IP:${NC} ${WHITE}$encrypted_ip${NC}"
                ;;
            6)
                echo -e "\n${CYAN}Введите зашифрованный IP:${NC}"
                read encrypted_ip
                decrypted_ip=$(echo "$encrypted_ip" | tr '9876543210@' '0123456789.')
                echo -e "${GREEN}Расшифрованный IP:${NC} ${WHITE}$decrypted_ip${NC}"
                ;;
            7) return ;;
            *) echo -e "${RED}Неверный выбор!${NC}"; sleep 1 ;;
        esac

        echo -e "\n${YELLOW}Нажмите Enter для продолжения...${NC}"
        read
    done
}

account_settings_menu() {
    while true; do
        clear
        echo -e "${PURPLE}╔════════════════════════════════════════╗${NC}"
        echo -e "${PURPLE}║       НАСТРОЙКИ АККАУНТА             ║${NC}"
        echo -e `${PURPLE}╚════════════════════════════════════════╝${NC}\n`  >/dev/null 2>&1
        echo -e "${CYAN}Текущий пользователь: ${WHITE}$current_user${NC}"
        echo -e "${BLUE}ID пользователя: ${WHITE}$current_user_id${NC}"
        echo -e "${YELLOW}Язык: ${WHITE}$current_language${NC}\n"

        echo -e "${GREEN}1. Изменить имя пользователя${NC}"
        echo -e "${GREEN}2. Изменить пароль${NC}"
        echo -e "${GREEN}3. Показать ID${NC}"
        echo -e "${GREEN}4. Выйти${NC}"

        echo -e "\n${WHITE}════════════════════════════════════════${NC}"
        read -p "Выберите действие (1-4): " choice

        case $choice in
            1)
                echo -e "\n${CYAN}Текущее имя: ${WHITE}$current_user${NC}"
                read -p "Введите новое имя: " new_name
                if [ -n "$new_name" ]; then
                    old_name="$current_user"
                    current_user="$new_name"
                    echo -e "${GREEN}Имя изменено на: ${WHITE}$current_user${NC}"
                    log_audit "USERNAME_CHANGE" "Changed from $old_name to $new_name"
                fi
                ;;
            2)
                echo -e "\n${YELLOW}Смена пароля${NC}"
                read -sp "Введите текущий пароль: " current_pass
                echo
                read -sp "Введите новый пароль: " new_pass1
                echo
                read -sp "Повторите новый пароль: " new_pass2
                echo

                if [ "$new_pass1" = "$new_pass2" ]; then
                    if [ ${#new_pass1} -ge 6 ]; then
                        echo -e "${GREEN}Пароль успешно изменен!${NC}"
                        log_audit "PASSWORD_CHANGE" "Password changed successfully"
                    else
                        echo -e "${RED}Пароль должен содержать минимум 6 символов!${NC}"
                    fi
                else
                    echo -e "${RED}Пароли не совпадают!${NC}"
                fi
                ;;
            3)
                echo -e "\n${CYAN}Ваш ID пользователя:${NC}"
                echo -e "${WHITE}$current_user_id${NC}"
                echo -e "${YELLOW}Используйте этот ID для входа в систему${NC}"
                ;;
            4) return ;;
            *) echo -e "${RED}Неверный выбор!${NC}"; sleep 1 ;;
        esac

        echo -e "\n${YELLOW}Нажмите Enter для продолжения...${NC}"
        read
    done
}

# ============================================
# ГЛАВНЫЙ ЦИКЛ ПРОГРАММЫ
# ============================================

main() {
    # Инициализация
    init_secure_environment

    # Главный цикл
    while true; do
        show_welcome_menu

        if [ -z "$current_user" ]; then
            # Меню для неавторизованных пользователей
            read -p "Выберите действие (1-4): " choice

            case $choice in
                1) login_user ;;
                2) register_user ;;
                3) change_color_theme_menu ;;
                4)
                    echo -e "\n${GREEN}Спасибо за использование Terminal Encryptor!${NC}"
                    echo -e "${YELLOW}Не забудьте подписаться на канал: $NEWS_CHANNEL${NC}"
                    log_audit "SYSTEM_EXIT" "User exited the system"
                    exit 0
                    ;;
                *) echo -e "${RED}Неверный выбор!${NC}"; sleep 1 ;;
            esac
        else
            # Меню для авторизованных пользователей
            read -p "Выберите действие (1-8): " choice

            case $choice in
                1) encryption_menu ;;
                2)
                    echo -e "\n${YELLOW}Модуль управления каналами в разработке...${NC}"
                    sleep 2
                    ;;
                3)
                    echo -e "\n${YELLOW}Модуль управления сетями в разработке...${NC}"
                    sleep 2
                    ;;
                4)
                    echo -e "\n${YELLOW}Модуль настроек в разработке...${NC}"
                    sleep 2
                    ;;
                5) account_settings_menu ;;
                6)
                    echo -e "\n${YELLOW}Модуль друзей в разработке...${NC}"
                    sleep 2
                    ;;
                7) change_color_theme_menu ;;
                8)
                    echo -e "\n${GREEN}Выход из аккаунта...${NC}"
                    log_audit "USER_LOGOUT" "User logged out: $current_user"
                    current_user=""
                    current_user_id=""
                    session_token=""
                    sleep 2
                    ;;
                *) echo -e "${RED}Неверный выбор!${NC}"; sleep 1 ;;
            esac
        fi
    done
}

# ============================================
# ЗАПУСК ПРОГРАММЫ
# ============================================

# Проверка зависимостей
check_dependencies() {
    local missing=0

    echo -e "${CYAN}Проверка зависимостей...${NC}"

    # Проверка наличия openssl
    if ! command -v openssl &> /dev/null; then
        echo -e "${RED}✗ OpenSSL не установлен${NC}"
        echo -e "${YELLOW}Установите: pkg install openssl${NC}"
        missing=1
    else
        echo -e "${GREEN}✓ OpenSSL установлен${NC}"
    fi

    # Проверка наличия sha256sum
    if ! command -v sha256sum &> /dev/null; then
        echo -e "${RED}✗ sha256sum не найден${NC}"
        echo -e "${YELLOW}Установите: pkg install coreutils${NC}"
        missing=1
    else
        echo -e "${GREEN}✓ sha256sum установлен${NC}"
    fi

    if [ $missing -eq 1 ]; then
        echo -e "\n${RED}Установите недостающие зависимости и перезапустите скрипт${NC}"
        exit 1
    fi

    echo -e "\n${GREEN}Все зависимости удовлетворены!${NC}"
    sleep 1
}

# Начало выполнения
echo -e "${PURPLE}══════════════════════════════════════════════════════════${NC}"
echo -e "${PURPLE}          TERMINAL ENCRYPTOR V1.1.2                      ${NC}"
echo -e "${PURPLE}       Secure Edition with Color Themes                  ${NC}"
echo -e "${PURPLE}══════════════════════════════════════════════════════════${NC}"
echo -e "${CYAN}Поддержка: $DEVELOPER_TG | Новости: $NEWS_CHANNEL${NC}\n"

check_dependencies
main
